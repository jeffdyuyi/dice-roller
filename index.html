<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>秘密基地骰子工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Roboto+Mono:wght@500&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }

        /* --- Animations --- */
        .dice-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .dice-btn:active { transform: scale(0.95); }
        .dice-btn::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .dice-btn:active::after { width: 200%; height: 200%; }

        .result-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Dice Shake/Roll Animation --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-5deg); }
            20% { transform: translate(-3px, 0px) rotate(5deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(5deg); }
            50% { transform: translate(-1px, 2px) rotate(-5deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-5deg); }
            80% { transform: translate(-1px, -1px) rotate(5deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-5deg); }
        }
        
        @keyframes error-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .input-error {
            animation: error-shake 0.3s ease-in-out;
            border-color: #ef4444 !important; /* Red 500 */
        }

        .rolling-dice {
            animation: shake 0.5s infinite;
        }
        .rolling-icon {
            animation: spin 0.5s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- Daggerheart Specifics --- */
        .dh-hope { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.3); } 
        .dh-fear { color: #a855f7; text-shadow: 0 0 10px rgba(168, 85, 247, 0.3); } 
        
        /* --- Tab Styles --- */
        .tab-btn.active {
            background-color: #334155; /* Slate 700 */
            color: #fff;
            border-bottom-color: #818cf8; /* Indigo 400 */
        }
        .tab-btn {
            border-bottom: 2px solid transparent;
        }

        /* Glassmorphism for Right Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="text-slate-200 h-[100dvh] overflow-hidden flex flex-col md:flex-row">

    <!-- LEFT SIDEBAR: Controls -->
    <div class="w-full md:w-[400px] flex flex-col bg-slate-800 border-b md:border-b-0 md:border-r border-slate-700 z-20 shadow-2xl shrink-0 h-[55%] md:h-full">
        
        <!-- Header -->
        <div class="bg-slate-900 p-4 border-b border-slate-700 shrink-0 flex items-center justify-between">
            <h1 onclick="showCredits()" class="text-lg font-bold flex items-center gap-2 text-indigo-400 cursor-pointer hover:text-indigo-300 transition-colors select-none" title="点击查看作者信息">
                <i class="fa-solid fa-dice-d20"></i> 秘密基地骰子工具
            </h1>
            <div class="text-xs text-slate-500 font-mono">v2.3</div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex bg-slate-800 border-b border-slate-700 shrink-0">
            <button onclick="switchTab('standard')" id="tab-btn-standard" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-slate-400 hover:text-slate-200 transition active">
                标准
            </button>
            <button onclick="switchTab('formula')" id="tab-btn-formula" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-slate-400 hover:text-slate-200 transition">
                公式
            </button>
            <button onclick="switchTab('daggerheart')" id="tab-btn-daggerheart" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-slate-400 hover:text-slate-200 transition">
                匕首心
            </button>
        </div>

        <!-- Scrollable Control Area -->
        <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            
            <!-- TAB: Standard Dice -->
            <div id="tab-standard" class="space-y-6">
                <!-- Settings -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">数量 (N)</label>
                        <div class="relative flex items-center">
                            <button onclick="adjustValue('diceCount', -1)" class="w-8 h-10 bg-slate-700 hover:bg-slate-600 rounded-l text-slate-300">-</button>
                            <input type="number" id="diceCount" value="1" min="1" max="50" class="flex-1 h-10 bg-slate-900 border-y border-slate-700 text-center text-white font-mono focus:outline-none">
                            <button onclick="adjustValue('diceCount', 1)" class="w-8 h-10 bg-slate-700 hover:bg-slate-600 rounded-r text-slate-300">+</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase tracking-wider">修正 (+/-)</label>
                        <div class="relative flex items-center">
                            <button onclick="adjustValue('diceMod', -1)" class="w-8 h-10 bg-slate-700 hover:bg-slate-600 rounded-l text-slate-300">-</button>
                            <input type="number" id="diceMod" value="0" class="flex-1 h-10 bg-slate-900 border-y border-slate-700 text-center text-white font-mono focus:outline-none">
                            <button onclick="adjustValue('diceMod', 1)" class="w-8 h-10 bg-slate-700 hover:bg-slate-600 rounded-r text-slate-300">+</button>
                        </div>
                    </div>
                </div>

                <!-- Dice Grid (3 columns for sidebar) -->
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="rollStandard(4)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D4</span>
                        <i class="fa-solid fa-dice-d6 transform rotate-45 text-lg"></i>
                    </button>
                    <button onclick="rollStandard(6)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D6</span>
                        <i class="fa-solid fa-dice-d6 text-lg"></i>
                    </button>
                    <button onclick="rollStandard(8)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D8</span>
                        <i class="fa-solid fa-dice-d20 transform rotate-180 text-lg"></i>
                    </button>
                    <button onclick="rollStandard(10)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D10</span>
                        <span class="font-mono font-bold text-lg leading-none">10</span>
                    </button>
                    <button onclick="rollStandard(12)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D12</span>
                        <span class="font-mono font-bold text-lg leading-none">12</span>
                    </button>
                    <button onclick="rollStandard(100)" class="dice-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-indigo-900/30 flex flex-col items-center justify-center gap-1 group">
                        <span class="text-[10px] opacity-70">D100</span>
                        <span class="font-mono font-bold text-lg leading-none">%</span>
                    </button>
                    <!-- D20 spans full width -->
                    <button onclick="rollStandard(20)" class="dice-btn col-span-3 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-3 md:py-4 rounded shadow-lg shadow-pink-900/30 flex items-center justify-center gap-3 group mt-1 md:mt-2">
                        <i class="fa-solid fa-dice-d20 text-xl md:text-2xl group-hover:rotate-180 transition-transform duration-500"></i>
                        <span class="text-lg md:text-xl tracking-widest">ROLL D20</span>
                    </button>
                </div>

                <!-- Custom Dice -->
                <div class="pt-4 border-t border-slate-700/50">
                    <label class="block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider">自定义面数 (Enter投掷)</label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-mono text-sm">D</span>
                            <input type="number" id="customSides" placeholder="50" class="w-full bg-slate-900 border border-slate-700 pl-8 pr-3 py-2 rounded text-white focus:outline-none focus:border-indigo-500 text-sm h-10 transition-colors">
                        </div>
                        <button onclick="rollCustom()" class="bg-slate-700 hover:bg-slate-600 text-white px-4 rounded transition font-medium text-sm h-10">
                            投掷
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: Formula -->
            <div id="tab-formula" class="hidden space-y-4">
                <div class="bg-slate-900/50 p-3 rounded border border-slate-700/50">
                    <p class="text-xs text-slate-400 mb-1"><i class="fa-solid fa-keyboard mr-1"></i> 构建公式</p>
                    <textarea id="formulaInput" rows="2" class="w-full bg-transparent text-white focus:outline-none font-mono text-lg placeholder-slate-600 resize-none" placeholder="2d6 + 1d8..."></textarea>
                </div>

                <!-- Expanded Formula Keypad -->
                <div class="grid grid-cols-4 gap-2">
                    <!-- Row 1 -->
                    <button onclick="insertText('d4')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d4</button>
                    <button onclick="insertText('d6')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d6</button>
                    <button onclick="insertText('d8')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d8</button>
                    <button onclick="insertText('d10')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d10</button>
                    
                    <!-- Row 2 -->
                    <button onclick="insertText('d12')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d12</button>
                    <button onclick="insertText('d20')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d20</button>
                    <button onclick="insertText('d100')" class="bg-slate-700 hover:bg-slate-600 text-xs py-2 md:py-3 rounded text-slate-300 font-mono">d%</button>
                    <button onclick="clearFormula()" class="bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs py-2 md:py-3 rounded border border-red-900/50"><i class="fa-solid fa-trash"></i></button>

                    <!-- Row 3: Operators & Big button -->
                    <button onclick="insertText('+')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold text-sm py-2 md:py-3 rounded">+</button>
                    <button onclick="insertText('-')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold text-sm py-2 md:py-3 rounded">-</button>
                    <button onclick="rollFormula()" class="col-span-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 md:py-3 rounded flex items-center justify-center gap-2">
                        <i class="fa-solid fa-calculator"></i> 计算
                    </button>
                </div>
                
                <div class="text-[10px] text-slate-500 text-center mt-2">
                    支持格式: <code class="text-slate-400">2d6+5</code>, <code class="text-slate-400">1d20-1d4</code>
                </div>
            </div>

            <!-- TAB: Daggerheart (UPDATED ANIMATION) -->
            <div id="tab-daggerheart" class="hidden flex flex-col items-center pt-4">
                <!-- Visuals -->
                <div class="flex items-center justify-center gap-4 mb-8">
                    <!-- Hope Die -->
                    <div class="flex flex-col items-center gap-1">
                        <div id="dh-hope-box" class="w-16 h-16 bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-xl flex items-center justify-center shadow-lg shadow-yellow-900/30 border border-yellow-500/30 relative transition-transform">
                             <i id="dh-hope-icon" class="fa-solid fa-sun text-2xl text-white opacity-90"></i>
                        </div>
                        <div class="text-[10px] font-bold text-yellow-500 tracking-widest uppercase mt-1">HOPE</div>
                        <div id="dh-hope-val" class="h-6 text-xl font-bold text-yellow-400 transition-all opacity-0 transform translate-y-2">-</div>
                    </div>
                    
                    <div class="text-slate-600 font-bold text-lg pb-6">VS</div>
                    
                    <!-- Fear Die -->
                    <div class="flex flex-col items-center gap-1">
                        <div id="dh-fear-box" class="w-16 h-16 bg-gradient-to-br from-purple-800 to-slate-950 rounded-xl flex items-center justify-center shadow-lg shadow-purple-900/30 border border-purple-500/30 relative transition-transform">
                            <i id="dh-fear-icon" class="fa-solid fa-moon text-2xl text-purple-200 opacity-80"></i>
                        </div>
                        <div class="text-[10px] font-bold text-purple-500 tracking-widest uppercase mt-1">FEAR</div>
                        <div id="dh-fear-val" class="h-6 text-xl font-bold text-purple-400 transition-all opacity-0 transform translate-y-2">-</div>
                    </div>
                </div>

                <!-- Modifier Input -->
                <div class="w-full mb-6 px-4">
                    <label class="block text-[10px] font-bold text-slate-500 mb-1 text-center uppercase tracking-wider">额外修正 (Modifier)</label>
                    <div class="relative flex items-center justify-center">
                        <button onclick="adjustValue('dhMod', -1)" class="w-10 h-10 text-slate-400 bg-slate-700 hover:bg-slate-600 rounded-l">-</button>
                        <input type="number" id="dhMod" value="0" class="w-20 h-10 bg-slate-900 border-y border-slate-700 text-center text-white font-mono text-lg focus:outline-none">
                        <button onclick="adjustValue('dhMod', 1)" class="w-10 h-10 text-slate-400 bg-slate-700 hover:bg-slate-600 rounded-r">+</button>
                    </div>
                </div>

                <button onclick="rollDaggerheart()" id="dhRollBtn" class="w-full bg-gradient-to-r from-yellow-700 via-slate-700 to-purple-800 hover:from-yellow-600 hover:to-purple-700 text-white font-bold py-3 md:py-4 rounded-lg shadow-lg border border-white/10 flex items-center justify-center gap-2 group transition-all active:scale-95">
                    <span>ROLL DUEL</span>
                    <i class="fa-solid fa-angles-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Display & History -->
    <div class="flex-1 flex flex-col bg-slate-900 relative overflow-hidden">
        <!-- Background Decor -->
        <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-indigo-600/5 rounded-full blur-3xl pointer-events-none -translate-y-1/2 translate-x-1/2"></div>
        <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-purple-600/5 rounded-full blur-3xl pointer-events-none translate-y-1/2 -translate-x-1/2"></div>

        <!-- HERO RESULT AREA -->
        <div id="heroArea" class="h-[55%] md:h-[40%] min-h-[160px] md:min-h-[250px] shrink-0 flex flex-col items-center justify-center relative border-b border-slate-800 z-10 transition-colors duration-500">
            
            <div id="welcomeMsg" class="text-slate-600 text-sm font-mono animate-pulse">Waiting for roll...</div>

            <div id="resultContainer" class="hidden flex flex-col items-center text-center w-full px-4">
                <!-- Top Label -->
                <div class="text-xs md:text-sm font-bold tracking-[0.2em] text-slate-400 mb-1 md:mb-2 uppercase" id="heroLabel">Standard Roll</div>
                
                <!-- Big Number -->
                <div class="relative group cursor-default">
                    <div class="text-[5rem] md:text-[8rem] leading-none font-black text-white drop-shadow-2xl result-enter select-all" id="heroTotal">20</div>
                    <div class="absolute -right-6 md:-right-8 top-0 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] md:text-xs text-slate-500 vertical-lr">Total</div>
                </div>

                <!-- Status Tag (Crit, Hope, etc) -->
                <div id="heroTag" class="mt-2 md:mt-4 px-3 md:px-4 py-1 md:py-1.5 rounded-full text-xs md:text-sm font-bold uppercase tracking-widest border backdrop-blur-md hidden shadow-lg transform transition-all duration-300 hover:scale-105">
                    Critical Success
                </div>

                <!-- Detail Breakdown -->
                <div class="mt-3 md:mt-6 text-slate-500 font-mono text-xs md:text-sm bg-slate-900/50 px-3 md:px-4 py-1.5 md:py-2 rounded-lg border border-slate-800/50" id="heroBreakdown">
                    [14, 2] + 4
                </div>
            </div>
        </div>

        <!-- HISTORY LIST -->
        <div class="flex-1 overflow-y-auto bg-slate-900/50 relative">
            <div class="sticky top-0 bg-slate-900/95 backdrop-blur border-b border-slate-800 p-3 flex justify-between items-center z-10">
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-2">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i> 历史记录
                </h3>
                <button onclick="clearHistory()" class="text-[10px] text-slate-600 hover:text-red-400 transition uppercase font-bold tracking-wider px-2">清除</button>
            </div>
            
            <ul id="historyList" class="p-4 space-y-3 pb-20">
                <!-- History Items go here -->
            </ul>
        </div>
    </div>

    <!-- Credits Modal -->
    <div id="creditsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" onclick="hideCredits()">
        <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center relative" onclick="event.stopPropagation()">
            <button onclick="hideCredits()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <div class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-900/50">
                <i class="fa-solid fa-user-astronaut text-3xl text-white"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">关于作者</h3>
            <p class="text-slate-300 font-medium mb-4">制作者：不咕鸟（基德）</p>
            
            <div class="space-y-3 text-sm text-slate-400 bg-slate-900/50 p-4 rounded-xl">
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] uppercase font-bold text-slate-500">成都线下面团秘密基地</span>
                    <span class="font-mono text-indigo-400 select-all">群号: 691707475</span>
                </div>
                <div class="w-full h-px bg-slate-700/50"></div>
                <div class="flex flex-col gap-1">
                    <span class="text-[10px] uppercase font-bold text-slate-500">不咕鸟TRPG创想俱乐部</span>
                    <span class="font-mono text-indigo-400 select-all">群号: 261751459</span>
                </div>
            </div>
            
            <p class="mt-6 text-xs text-slate-600">点击任意处关闭</p>
        </div>
    </div>

    <script>
        // --- State ---
        let currentTab = 'standard';
        let isRolling = false;

        // --- Elements ---
        const els = {
            tabs: {
                standard: document.getElementById('tab-standard'),
                formula: document.getElementById('tab-formula'),
                daggerheart: document.getElementById('tab-daggerheart')
            },
            btns: {
                standard: document.getElementById('tab-btn-standard'),
                formula: document.getElementById('tab-btn-formula'),
                daggerheart: document.getElementById('tab-btn-daggerheart')
            },
            inputs: {
                count: document.getElementById('diceCount'),
                mod: document.getElementById('diceMod'),
                custom: document.getElementById('customSides'),
                formula: document.getElementById('formulaInput'),
                dhMod: document.getElementById('dhMod')
            },
            dh: {
                hopeBox: document.getElementById('dh-hope-box'),
                hopeIcon: document.getElementById('dh-hope-icon'),
                hopeVal: document.getElementById('dh-hope-val'),
                fearBox: document.getElementById('dh-fear-box'),
                fearIcon: document.getElementById('dh-fear-icon'),
                fearVal: document.getElementById('dh-fear-val'),
                btn: document.getElementById('dhRollBtn')
            },
            hero: {
                container: document.getElementById('resultContainer'),
                welcome: document.getElementById('welcomeMsg'),
                label: document.getElementById('heroLabel'),
                total: document.getElementById('heroTotal'),
                breakdown: document.getElementById('heroBreakdown'),
                tag: document.getElementById('heroTag'),
                area: document.getElementById('heroArea')
            },
            history: document.getElementById('historyList')
        };

        // --- Initialize Listeners ---
        // Fix: Enable Enter key for custom sides
        if (els.inputs.custom) {
            els.inputs.custom.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') rollCustom();
            });
            // Clear error on input
            els.inputs.custom.addEventListener('input', () => {
                els.inputs.custom.classList.remove('input-error');
            });
        }

        // --- Functions ---
        function showCredits() {
            document.getElementById('creditsModal').classList.remove('hidden');
        }
        function hideCredits() {
            document.getElementById('creditsModal').classList.add('hidden');
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            Object.keys(els.tabs).forEach(k => {
                if (k === tabName) els.tabs[k].classList.remove('hidden');
                else els.tabs[k].classList.add('hidden');
            });

            Object.keys(els.btns).forEach(k => {
                if (k === tabName) {
                    els.btns[k].classList.add('active');
                    els.btns[k].classList.remove('text-slate-400');
                } else {
                    els.btns[k].classList.remove('active');
                    els.btns[k].classList.add('text-slate-400');
                }
            });
        }

        function adjustValue(id, delta) {
            const el = document.getElementById(id);
            let val = parseInt(el.value) || 0;
            val += delta;
            if (id === 'diceCount' && val < 1) val = 1;
            el.value = val;
        }

        function insertText(text) {
            const input = els.inputs.formula;
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const val = input.value;
            let insertion = text;
            if (text === '+' || text === '-') insertion = ` ${text} `;
            input.value = val.substring(0, start) + insertion + val.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + insertion.length;
        }

        function clearFormula() {
            els.inputs.formula.value = '';
            els.inputs.formula.focus();
        }

        // --- Roll Logic ---

        function rollStandard(sides) {
            const count = parseInt(els.inputs.count.value) || 1;
            const mod = parseInt(els.inputs.mod.value) || 0;
            
            let rolls = [];
            let sum = 0;
            let isCritSuccess = false;
            let isCritFail = false;

            for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * sides) + 1;
                rolls.push(r);
                sum += r;
            }

            if (count === 1 && sides === 20) {
                if (rolls[0] === 20) isCritSuccess = true;
                if (rolls[0] === 1) isCritFail = true;
            }

            const total = sum + mod;
            const formulaStr = `${count}d${sides}` + (mod ? (mod > 0 ? `+${mod}` : `${mod}`) : '');
            
            let rollsStr = rolls.join(', ');
            if (rolls.length > 10) rollsStr = rolls.slice(0, 10).join(', ') + '...';
            const breakdownStr = `[${rollsStr}]` + (mod ? (mod > 0 ? ` + ${mod}` : ` - ${Math.abs(mod)}`) : '');

            let tag = null;
            if (isCritSuccess) tag = { text: "Critical Success", color: "text-green-400", bg: "bg-green-500/10", border: "border-green-500/50" };
            if (isCritFail) tag = { text: "Critical Fail", color: "text-red-400", bg: "bg-red-500/10", border: "border-red-500/50" };

            // Determine Label Type
            const standardDice = [4, 6, 8, 10, 12, 20, 100];
            const typeLabel = standardDice.includes(sides) ? "Standard" : "Custom";

            updateHero(total, formulaStr, breakdownStr, tag);
            addHistoryItem(typeLabel, formulaStr, total, breakdownStr, tag);
        }

        function rollCustom() {
            const input = els.inputs.custom;
            const sides = parseInt(input.value);
            
            // Validation Feedback
            if (!sides || sides < 2) {
                input.classList.remove('input-error');
                void input.offsetWidth; // trigger reflow
                input.classList.add('input-error');
                input.focus();
                return;
            }
            
            rollStandard(sides);
        }

        function rollFormula() {
            let input = els.inputs.formula.value.toLowerCase().trim();
            if (!input) return;
            
            input = input.replace(/\s+/g, '');
            const terms = input.split(/([+-])/).filter(t => t);
            
            let total = 0;
            let breakdownParts = [];
            let currentSign = 1;
            let valid = true;

            for (let i = 0; i < terms.length; i++) {
                let term = terms[i];
                if (term === '+') { currentSign = 1; continue; }
                if (term === '-') { currentSign = -1; continue; }

                if (term.includes('d')) {
                    let [cStr, sStr] = term.split('d');
                    let c = cStr === '' ? 1 : parseInt(cStr);
                    let s = parseInt(sStr);
                    
                    if (isNaN(c) || isNaN(s)) { valid = false; break; }

                    let subT = 0;
                    let subR = [];
                    for(let j=0; j<c; j++) {
                        let r = Math.floor(Math.random() * s) + 1;
                        subR.push(r);
                        subT += r;
                    }
                    total += (subT * currentSign);
                    breakdownParts.push(`${currentSign === 1 ? (breakdownParts.length > 0 ? '+ ' : '') : '- '}[${subR.reduce((a,b)=>a+b,0)}]`);
                } else {
                    let v = parseInt(term);
                    if (!isNaN(v)) {
                        total += (v * currentSign);
                        breakdownParts.push(`${currentSign === 1 ? (breakdownParts.length > 0 ? '+ ' : '') : '- '}${v}`);
                    }
                }
            }

            if (!valid) {
                alert("公式格式错误");
                return;
            }

            const cleanInput = els.inputs.formula.value; 
            updateHero(total, "Formula", cleanInput + " = " + breakdownParts.join(' '), null);
            addHistoryItem("Formula", cleanInput, total, breakdownParts.join(' '));
        }

        // --- UPDATED Daggerheart Logic with Animation ---
        function rollDaggerheart() {
            if (isRolling) return;
            isRolling = true;
            els.dh.btn.classList.add('opacity-50', 'cursor-not-allowed');

            // 1. Reset Values & Start Animation
            els.dh.hopeVal.classList.remove('opacity-100', 'translate-y-0');
            els.dh.hopeVal.classList.add('opacity-0', 'translate-y-2');
            els.dh.fearVal.classList.remove('opacity-100', 'translate-y-0');
            els.dh.fearVal.classList.add('opacity-0', 'translate-y-2');

            // Add animation classes
            els.dh.hopeBox.classList.add('rolling-dice');
            els.dh.fearBox.classList.add('rolling-dice');
            els.dh.hopeIcon.classList.add('rolling-icon');
            els.dh.fearIcon.classList.add('rolling-icon');

            // 2. Wait for animation (simulating roll)
            setTimeout(() => {
                const mod = parseInt(els.inputs.dhMod.value) || 0;
                const hope = Math.floor(Math.random() * 12) + 1;
                const fear = Math.floor(Math.random() * 12) + 1;
                const total = hope + fear + mod;

                // Stop Animation
                els.dh.hopeBox.classList.remove('rolling-dice');
                els.dh.fearBox.classList.remove('rolling-dice');
                els.dh.hopeIcon.classList.remove('rolling-icon');
                els.dh.fearIcon.classList.remove('rolling-icon');

                // Update Values
                els.dh.hopeVal.innerText = hope;
                els.dh.fearVal.innerText = fear;

                // Reveal Values
                els.dh.hopeVal.classList.remove('opacity-0', 'translate-y-2');
                els.dh.hopeVal.classList.add('opacity-100', 'translate-y-0');
                els.dh.fearVal.classList.remove('opacity-0', 'translate-y-2');
                els.dh.fearVal.classList.add('opacity-100', 'translate-y-0');

                let status = "";
                let tag = {};

                if (hope === fear) {
                    status = "Critical (Hope Clear)";
                    tag = { text: status, color: "text-emerald-400", bg: "bg-emerald-500/10", border: "border-emerald-500/50" };
                } else if (hope > fear) {
                    status = "With Hope";
                    tag = { text: status, color: "text-yellow-400", bg: "bg-yellow-500/10", border: "border-yellow-500/50" };
                } else {
                    status = "With Fear";
                    tag = { text: status, color: "text-purple-400", bg: "bg-purple-500/10", border: "border-purple-500/50" };
                }

                const breakdownHTML = `<span class="dh-hope">H:${hope}</span> <span class="text-slate-600">/</span> <span class="dh-fear">F:${fear}</span>${mod ? (mod > 0 ? ` + ${mod}` : ` ${mod}`) : ''}`;

                updateHero(total, "Daggerheart Check", breakdownHTML, tag, true);
                addHistoryItem("DH", "2d12 Duel", total, `Hope ${hope}, Fear ${fear}`, tag);

                // Reset State
                isRolling = false;
                els.dh.btn.classList.remove('opacity-50', 'cursor-not-allowed');

            }, 600); // Animation duration
        }

        // --- UI Updates ---

        function updateHero(total, label, breakdown, tag, isHTML = false) {
            const { welcome, container, total: tEl, label: lEl, breakdown: bEl, tag: tagEl, area } = els.hero;
            
            welcome.classList.add('hidden');
            container.classList.remove('hidden');

            tEl.classList.remove('result-enter');
            void tEl.offsetWidth;
            tEl.classList.add('result-enter');

            tEl.innerText = total;
            lEl.innerText = label;
            
            if (isHTML) bEl.innerHTML = breakdown;
            else bEl.innerText = breakdown;

            tagEl.classList.add('hidden');
            tEl.className = "text-[5rem] md:text-[8rem] leading-none font-black text-white drop-shadow-2xl result-enter select-all transition-colors duration-300";
            
            if (tag) {
                tagEl.className = `mt-2 md:mt-4 px-3 md:px-4 py-1 md:py-1.5 rounded-full text-xs md:text-sm font-bold uppercase tracking-widest border backdrop-blur-md shadow-lg transform transition-all duration-300 hover:scale-105 ${tag.color} ${tag.bg} ${tag.border}`;
                tagEl.innerText = tag.text;
                tagEl.classList.remove('hidden');

                if (tag.color.includes('green') || tag.color.includes('emerald')) tEl.classList.add('text-green-400');
                if (tag.color.includes('red')) tEl.classList.add('text-red-400');
                if (tag.color.includes('yellow')) tEl.classList.add('text-yellow-400');
                if (tag.color.includes('purple')) tEl.classList.add('text-purple-400');
            }
        }

        function addHistoryItem(type, formula, total, details, tag) {
            const li = document.createElement('li');
            li.className = "flex items-start gap-4 p-4 bg-slate-800 rounded-xl border border-slate-700/50 hover:border-indigo-500/30 transition result-enter";
            
            let icon = "fa-dice-d20";
            if (type === "Formula") icon = "fa-calculator";
            if (type === "DH") icon = "fa-shield-heart";
            if (type === "Custom") icon = "fa-dice-d6";

            let tagHTML = '';
            if (tag) {
                tagHTML = `<span class="text-[10px] uppercase font-bold px-2 py-0.5 rounded ${tag.bg} ${tag.color} border ${tag.border} ml-2">${tag.text}</span>`;
            }

            li.innerHTML = `
                <div class="mt-1 text-slate-500"><i class="fa-solid ${icon}"></i></div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">${type}</span>
                            ${tagHTML}
                        </div>
                        <span class="text-xs text-slate-600 font-mono">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="text-sm text-slate-300 font-mono break-all">${formula}</div>
                    <div class="text-xs text-slate-500 break-all mt-0.5">${details}</div>
                </div>
                <div class="text-3xl font-bold text-white pl-4 border-l border-slate-700/50 flex items-center h-full">
                    ${total}
                </div>
            `;
            
            els.history.prepend(li);
        }

        function clearHistory() {
            els.history.innerHTML = '<div class="text-center text-slate-600 py-8 italic text-xs">记录已清除</div>';
            els.hero.container.classList.add('hidden');
            els.hero.welcome.classList.remove('hidden');
        }
    </script>
</body>
</html>